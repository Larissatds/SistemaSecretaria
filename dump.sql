--Criar Banco de dados
CREATE DATABASE SISTEMA_SECRETARIA;
GO

USE SISTEMA_SECRETARIA;
GO

--Criar login no servidor
CREATE LOGIN AdminLocal WITH PASSWORD = 'Admin123';

--Criar usuário no banco
USE SISTEMA_SECRETARIA;
CREATE USER AdminLocal FOR LOGIN AdminLocal;

--Dar permissões
ALTER ROLE db_owner ADD MEMBER AdminLocal;

--Criar tabela de tipos de usuário
CREATE TABLE TB_TIPOS_USUARIO (
    ID_TIPO_USUARIO NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
	NOME NVARCHAR(100) NOT NULL UNIQUE,
    DESCRICAO NVARCHAR(256) NULL
);
GO

--Inserir registro na tabela tipos de usuário
INSERT INTO TB_TIPOS_USUARIO VALUES ('Admin', 'Administrador do sistema')
GO

--Criar tabela de usuários
CREATE TABLE TB_USUARIOS (
    ID_USUARIO NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
    EMAIL NVARCHAR(256) NOT NULL UNIQUE,
    SENHA_HASH NVARCHAR(MAX) NOT NULL,
    ID_TIPO_USUARIO NUMERIC(15,0) NOT NULL,
    NOME_COMPLETO NVARCHAR(MAX) NULL,
    DATA_CRIACAO DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    DATA_ULTIMO_LOGIN DATETIME2 NULL,
	CONSTRAINT FK_USUARIOS_TIPOS_USUARIO FOREIGN KEY (ID_TIPO_USUARIO) REFERENCES TB_TIPOS_USUARIO(ID_TIPO_USUARIO)
);
GO

--Inserir registro na tabela usuários
INSERT INTO TB_USUARIOS(EMAIL, SENHA_HASH, ID_TIPO_USUARIO, NOME_COMPLETO, DATA_CRIACAO)
VALUES (
    'admin@secretaria.com',
    'AQAAAAEAACcQAAAAEB22JichORUJiOmOzJSlUT/eP6TSwt9WDIC7gD4mawtZMlOXsgw/FmqJRqBBCvGmHg==',
	1,
    'Administrador',
    GETUTCDATE()
);
 GO

--Criar tabela de alunos
CREATE TABLE TB_ALUNOS (
    ID_ALUNO NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
	NOME_COMPLETO NVARCHAR(MAX) NOT NULL,
	DATA_NASCIMENTO DATETIME2 NOT NULL,
	CPF NVARCHAR(11),
    EMAIL NVARCHAR(256) NOT NULL UNIQUE,
    SENHA_HASH NVARCHAR(MAX) NOT NULL
);
GO

--Criar tabela de turmas
CREATE TABLE TB_TURMAS (
    ID_TURMA NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
	NOME NVARCHAR(256) NOT NULL UNIQUE,
    DESCRICAO NVARCHAR(MAX) NULL
);
GO

--Criar tabela de matriculas
CREATE TABLE TB_MATRICULAS (
    ID_MATRICULA NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
    ID_ALUNO NUMERIC(15,0) NOT NULL,
    ID_TURMA NUMERIC(15,0) NOT NULL,
    DATA_MATRICULA DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    STATUS NVARCHAR(100) NOT NULL DEFAULT 'Ativo',

    CONSTRAINT FK_MATRICULAS_ESTUDANTES FOREIGN KEY (ID_ALUNO) REFERENCES TB_ALUNOS(ID_ALUNO),
    CONSTRAINT FK_MATRICULAS_TURMAS FOREIGN KEY (ID_TURMA) REFERENCES TB_TURMAS(ID_TURMA),
    CONSTRAINT UQ_MATRICULAS UNIQUE (ID_ALUNO, ID_TURMA) 
);
GO
