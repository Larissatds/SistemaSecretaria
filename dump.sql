--Criar Banco de dados
CREATE DATABASE SISTEMA_SECRETARIA;
GO

USE SISTEMA_SECRETARIA;
GO

--Criar login no servidor
CREATE LOGIN AdminLocal WITH PASSWORD = 'Admin123';

--Criar usuário no banco
USE SISTEMA_SECRETARIA;
CREATE USER AdminLocal FOR LOGIN AdminLocal;

--Dar permissões
ALTER ROLE db_owner ADD MEMBER AdminLocal;

--Criar tabela de tipos de usuário
CREATE TABLE TB_TIPOS_USUARIO (
    ID_TIPO_USUARIO NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
	NOME NVARCHAR(100) NOT NULL UNIQUE,
    DESCRICAO NVARCHAR(255) NULL
);
GO

--Inserir registro na tabela tipos de usuário
INSERT INTO TB_TIPOS_USUARIO VALUES ('Admin', 'Administrador do sistema')
GO

--Criar tabela de usuários
CREATE TABLE TB_USUARIOS (
    ID_USUARIO NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
    EMAIL NVARCHAR(256) NOT NULL UNIQUE,
    SENHA_HASH NVARCHAR(MAX) NOT NULL,
    ID_TIPO_USUARIO NUMERIC(15,0) NOT NULL,
    NOME_COMPLETO NVARCHAR(MAX) NULL,
    DATA_CRIACAO DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    DATA_ULTIMO_LOGIN DATETIME2 NULL,
	CONSTRAINT FK_USUARIOS_TIPOS_USUARIO FOREIGN KEY (ID_TIPO_USUARIO) REFERENCES TB_TIPOS_USUARIO(ID_TIPO_USUARIO)
);
GO

--Inserir registro na tabela usuários
INSERT INTO TB_USUARIOS(EMAIL, SENHA_HASH, ID_TIPO_USUARIO, NOME_COMPLETO, DATA_CRIACAO)
VALUES (
    'admin@secretaria.com',
    'fa2190774c91ea63cae5aeed564122b2',
	1,
    'Administrador',
    GETUTCDATE()
);
 GO

--Criar tabela de refresh token
CREATE TABLE TB_REFRESH_TOKENS (
    ID_REFRESH_TOKEN NUMERIC(15,0) IDENTITY(1,1) PRIMARY KEY NOT NULL,
    ID_USUARIO NUMERIC(15,0) NOT NULL,
    TOKEN NVARCHAR(500) NOT NULL,
    DATA_EXPIRACAO DATETIME2 NOT NULL,
    DATA_CRIACAO DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    DATA_REVOGACAO DATETIME2 NULL,
    CONSTRAINT FK_REFRESH_TOKENS_USUARIOS FOREIGN KEY (ID_USUARIO) REFERENCES TB_USUARIOS(ID_USUARIO)
);
GO
